---
title: 莫队学习笔记
date: 2023-04-08 22:26:36
description: WIP
categories: 学习笔记
tags:
  - 莫队
---

## 前言

莫队是一种用于解决静态区间查询问题的有力工具．

<!-- more -->

## 约定

序列长 $n$ ，询问数 $q$ 和值域大小 $V$ 同级．

若未加说明，下文中 $l$，$r$ 均指代莫队中维护的两个指针．

## 普通莫队

如果已知一个区间 $[l, r]$ 的信息，可以在小代价内转移得到 $[l \pm 1, r \pm 1]$ 的信息，那么我们可以使用普通莫队算法在 $O(n \sqrt{n})$ 的转移次数内得到所有询问区间的信息．

### 算法思想

对于这样的问题，我们很容易有一个朴素的想法：维护两个指针 $l$、$r$，按照询问顺序移动 $l$、$r$ 并维护区间 $[l, r]$ 的信息．但这样 $l$ 和 $r$ 的移动次数都达到了 $O(n^2)$，不可接受．

如果指针的移动有单调性就好了！于是我们将询问离线，按照左端点排序，再移动指针．这样我们就将 $l$ 的移动次数降到了 $O(n)$．但不幸的是，排序之后，右端点就失去了单调性，$r$ 的移动次数可达 $O(n^2)$．

按照左端点排序会使右端点失去单调性，反之亦然．于是我们想到根号平衡，可以让左端点损失一定的单调性，换来右端点一定的单调性，这样总移动次数就可以被平衡到一个可以接受的值．

于是我们按照块长 $\sqrt{n}$ 将序列分块，以左端点所在的块作为第一关键字，右端点作为第二关键字排序，再按照这个顺序移动指针，移动次数为 $O(n \sqrt{n})$．

### 复杂度分析

设块长为 $B$．

对于排序后两个相邻的询问，由于按左端点所在块的编号排了序，$l$ 的移动次数不会超过 $O(B)$ 次，则 $l$ 的总移动次数为 $O(nB)$．

而对于一个块中的所有询问，右端点单调，$r$ 的移动次数为 $O(n)$，总共有 $O(n / B)$ 个块，那么 $r$ 的总移动次数为 $O(n^2 / B)$．

总移动次数为 $O(nB + n^2 / B)$，$B = \sqrt{n}$ 时最优，为 $O(n \sqrt{n})$．

### 例题

#### 例 1. [SPOJ DQUERY D-query](https://www.spoj.com/problems/DQUERY/)

静态区间数颜色，考虑使用莫队解决．

莫队维护数 $i$ 在当前区间内出现的次数 $c_i$．插入 $x$ 时，若 $c_x = 0$，说明 $x$ 在当前区间第一次出现，维护的答案自增，删除时同理．总时间复杂度 $O(n \sqrt{n})$．

#### 例 2. [洛谷 1494 [国家集训队] 小 Z 的袜子](https://www.luogu.com.cn/problem/P1494)

记 $c_i$ 表示 $i$ 在当前区间出现的次数．对于一个询问区间 $[l, r]$，答案为：

$$
\sum_i \frac{\binom{c_i}{2}}{\binom{r - l + 1}{2}} = \frac{1}{(r - l + 1)(r - l)} \sum_i c_i (c_i - 1)
$$

莫队维护 $c$ 和 $\sum\limits_i c_i (c_i - 1)$，显然可以 $O(1)$ 移动指针，总时间复杂度 $O(n \sqrt{n})$．

#### 例 3. [洛谷 4396 [AHOI2013] 作业](https://www.luogu.com.cn/problem/P4396)

维护 $c_i$ 和 $d_i$，分别表示区间中 $i$ 出现的次数和 $i$ 是否出现过．$d_i$ 的维护类似于例 1．

询问是一个区间求和．为了支持区间求和操作，可以选择直接使用 BIT 维护 $c$ 和 $d$，但是这样移动指针的代价就是 $O(\log n)$，时间复杂度 $O(n \sqrt{n} \log n)$，难以通过本题．

考察莫队的算法流程，我们发现它会在内层数据结构上产生 $O(n \sqrt{n})$ 次修改和 $O(n)$ 次查询，而这显然是不平衡的．如果我们能够使用 $O(1)$ 修改，$O(\sqrt{n})$ 查询的数据结构替换 BIT，那么就可以将时间复杂度平衡到 $O(n \sqrt{n})$．

那么我们采用分块来维护 $c$ 和 $d$，容易做到 $O(1)$ 移动指针，$O(\sqrt{n})$ 查询区间和．总时间复杂度 $O(n \sqrt{n})$．

## 回滚莫队

在普通莫队中，当移动指针使得当前维护的区间长度增加时，我们称这次移动为插入，反之则称这次移动为删除．

当插入和删除操作中有一个难以实现时，可以采用回滚莫队算法在 $O(n \sqrt{n})$ 的转移次数内得到所有询问区间的信息．

### 算法思想

以难以实现删除操作的情况为例．

我们发现，即使是难以实现删除操作的信息，也可以快速实现撤销到某个特定点的操作．那么我们能不能基于插入和撤销两个操作，得到所有询问区间的信息呢？

考察普通莫队算法中给询问排序的作用，发现其本质是将询问挂在了左端点所在的块上，并保证挂在一个块上的所有询问右端点的单调性，从而保证时间复杂度．

考虑左端点在一个块中的所有询问，右端点已经单调增了，不需要对 $r$ 实施删除操作．但左端点是乱序的，为了规避对 $l$ 的删除操作，处理每个询问时，我们可以将 $l$ 撤销到当前块的右端点上，再进行移动．

遍历所有块．设当前块的右端点为 $\mathrm{br}$，将 $l$ 初始化为 $\mathrm{br}$，$r$ 初始化为 $\mathrm{br} - 1$，并且清空维护的所有信息，然后按上述操作处理左端点在当前块中的所有询问．

注意这样的算法无法处理左右端点在同一个块内的询问，这些询问暴力做即可．

难以实现插入操作的情况类似，不同之处如下：

- 给挂在一个块上的询问排序时，按照右端点降序排序．
- 遍历所有块时，设当前块的左端点为 $\mathrm{bl}$，将 $l$ 初始化为 $\mathrm{bl}$，$r$ 初始化为 $n$．

### 复杂度分析

同样以难以实现删除操作的情况为例．

设块长为 $B$．

对于每个询问，$l$ 都会从询问区间的左端点所在块的右端点移动到询问区间的左端点，移动次数为 $O(B)$，总移动次数为 $O(nB)$．$r$ 的移动次数分析和普通莫队一致．

总移动次数为 $O(nB + n^2 / B)$，$B = \sqrt{n}$ 时最优，为 $O(n \sqrt{n})$．

难以实现插入操作的情况类似．

### 例题

#### 例 1. [洛谷 5906 【模板】回滚莫队 & 不删除莫队](https://www.luogu.com.cn/problem/P5906)

#### 例 2. [JOISC2014C 歴史の研究](https://atcoder.jp/contests/joisc2014/tasks/joisc2014_c)

#### 例 3. [洛谷 4137 Rmq Problem / mex](https://www.luogu.com.cn/problem/P4137)

## 莫队二次离线

### 算法思想

### 复杂度分析

### 例题

#### 例 1. [洛谷 4887 【模板】莫队二次离线](https://www.luogu.com.cn/problem/P4887)

#### 例 2. [洛谷 5047 [Ynoi2019 模拟赛] Yuno loves sqrt technology II](https://www.luogu.com.cn/problem/P5047)

#### 例 3. [洛谷 5501 [LnOI2019] 来者不拒，去者不追](https://www.luogu.com.cn/problem/P5501)
